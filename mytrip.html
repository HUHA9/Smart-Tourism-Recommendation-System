<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Trip</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="style/trip.css" />

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f0f8ff;
    }
    h1 {
      text-align: center;
      color: #1e90ff;
    }
    .trip-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-bottom: 30px;
    }
    .trip-card {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      width: 250px;
      overflow: hidden;
      transition: transform 0.3s;
      position: relative;
    }
    .trip-card:hover {
      transform: translateY(-5px);
    }
    .trip-card img {
      width: 100%;
      height: 160px;
      object-fit: cover;
    }
    .trip-card .content {
      padding: 15px;
    }
    .trip-card h3 {
      margin: 0 0 10px;
      color: #1e90ff;
    }
    .trip-card p {
      margin: 5px 0;
      font-size: 14px;
    }
    .delete-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #ff4757;
      color: white;
      border: none;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.8;
    }
    .delete-btn:hover {
      opacity: 1;
    }
    .generate-plan {
      text-align: center;
      margin: 30px 0;
    }
    .generate-plan input, .generate-plan button {
      padding: 10px 15px;
      margin: 0 10px;
      border-radius: 5px;
      border: 1px solid #1e90ff;
    }
    .generate-plan button {
      background-color: #1e90ff;
      color: white;
      border: none;
      cursor: pointer;
    }
    .generate-plan button:hover {
      background-color: #187bcd;
    }
    .itinerary {
      max-width: 800px;
      margin: 0 auto;
      display: none;
    }
    .day-plan {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .day-title {
      color: #1e90ff;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    .attraction-item {
      display: flex;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px dashed #eee;
    }
    .attraction-img {
      width: 120px;
      height: 80px;
      object-fit: cover;
      border-radius: 5px;
      margin-right: 15px;
    }
    .attraction-info {
      flex: 1;
    }
    .attraction-name {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .attraction-desc {
      font-size: 13px;
      color: #666;
      margin-bottom: 5px;
    }
    .weather-info {
      display: flex;
      align-items: center;
      margin-top: 5px;
      font-size: 13px;
    }
    .weather-icon {
      width: 20px;
      height: 20px;
      margin-right: 5px;
    }
    .transportation {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed #eee;
    }
    .transport-title {
      font-weight: bold;
      font-size: 13px;
      margin-bottom: 5px;
    }
    .transport-options {
      display: flex;
      gap: 10px;
    }
    .transport-btn {
      padding: 5px 10px;
      background-color: #f0f8ff;
      border: 1px solid #1e90ff;
      border-radius: 3px;
      font-size: 12px;
      cursor: pointer;
    }
    .transport-btn:hover {
      background-color: #1e90ff;
      color: white;
    }
    .map-container {
      height: 200px;
      margin-top: 10px;
      border-radius: 5px;
      overflow: hidden;
    }
    .no-items {
      text-align: center;
      color: #666;
      margin: 50px 0;
    }
    .back-btn {
      display: block;
      text-align: center;
      margin: 20px auto;
      padding: 10px 20px;
      background-color: #1e90ff;
      color: white;
      border: none;
      border-radius: 5px;
      text-decoration: none;
      cursor: pointer;
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #4CAF50;
      color: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      z-index: 1000;
      display: none;
    }
  </style>
</head>
<body>
  <div class="notification" id="notification"></div>
  
  <h1>My Trip</h1>
  
  <div id="tripPlacesSection">
    <div class="trip-container" id="tripList"></div>
    
  </div>
  <div class="trip-controls-card">

    <!-- Start From -->
    <label style="font-weight:700;color:#1e90ff;">Start From:</label>
  
    <select id="startCity">
      <option value="Paris">Paris</option>
      <option value="Tokyo">Tokyo</option>
      <option value="Rome">Rome</option>
      <option value="Beijing">Beijing</option>
      <option value="Shanghai">Shanghai</option>
      <option value="Xi’an">Xi’an</option>
      <option value="Kuala Lumpur">Kuala Lumpur</option>
      <option value="Penang">Penang</option>
      <option value="Langkawi">Langkawi</option>
    </select>
  
    <select id="startType">
      <option value="hotel">Hotel</option>
      <option value="airport">Airport</option>
      <option value="landmark">Landmark</option>
    </select>
  
    <select id="startLocation"></select>
  
    <label>
      <input type="checkbox" id="returnToStart">
      Return to start each day
    </label>
  
    <!-- Transport -->
    <label style="font-weight:700;color:#1e90ff;">Transport:</label>
    <select id="transportMode">
      <option value="driving">Driving</option>
      <option value="walking">Walking</option>
      <option value="cycling">Cycling</option>
    </select>
    
    <label
  style="
    font-weight:700;
    color:#1e90ff;
    display:block;
    margin-top:10px;
  "
>
  Days:
</label>

<input
  type="number"
  id="numDays"
  value="1"
  min="1"
  style="
    width:70px;
    padding:6px;
    border-radius:6px;
    border:1px solid #1e90ff;
    display:inline-block;
  "
/>
    <!-- Buttons -->
    <button id="generateBtn" class="primary-btn">Generate Itinerary</button>
    <button id="addTop5Btn" class="secondary-btn">Add Top 5 Recs</button>
    
  
  </div>
  
  <div id="itinerary"></div>

  <div class="itinerary" id="itinerarySection">
    <h2>Your Travel Itinerary</h2>
    <div id="itineraryDays"></div>
    <!-- 放在 <div id="itineraryDays"></div> 的下方 -->
<div id="route-summary" style="
background: #f8fbff;
border: 1px solid #e6f0ff;
padding: 12px;
margin: 18px 0;
border-radius: 8px;
color:#222;
font-size:14px;
">
<div class="summary-box">
  <h3>Summary</h3>
  <div class="summary-content"></div>
</div>


</div>

    <button class="back-btn" id="backBtn">Back to My Places</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="scripts/utils.js"></script>
    <script src="scripts/attractions.js"></script>
    <script src="scripts/ors.js"></script>        <!-- optional but recommended -->
    <script src="scripts/tripEngine.js"></script>
    <script src="scripts/recommend.js"></script>
    <script src="scripts/startLocations.js"></script>
    <script src="scripts/map.js"></script>

  <script>
    const tripList = document.getElementById('tripList');
    const daysInput = document.getElementById('numDays');
    const generateBtn = document.getElementById('generateBtn');
    const itinerarySection = document.getElementById('itinerarySection');
    const itineraryDays = document.getElementById('itineraryDays');
    const backBtn = document.getElementById('backBtn');
    const tripPlacesSection = document.getElementById('tripPlacesSection');
    const notification = document.getElementById('notification');
    const WEATHER_API_KEY = 'cc63337a1eccdb4a731d7a2406b38a47';

    function showNotification(message, isSuccess = true) {
      notification.textContent = message;
      notification.style.backgroundColor = isSuccess ? '#4CAF50' : '#ff4757';
      notification.style.display = 'block';
      setTimeout(() => { notification.style.display = 'none'; }, 3000);
    }

    function removeDuplicateTrips() {
      let trips = JSON.parse(localStorage.getItem('myTrip')) || [];
      const seen = new Set();
      const filtered = [];
      trips.forEach(trip => {
        const key = `${trip.name}-${trip.city}`;
        if (!seen.has(key)) {
          seen.add(key);
          filtered.push(trip);
        }
      });
      localStorage.setItem('myTrip', JSON.stringify(filtered));
    }

    function addTopNToMyTrip(n = 5) {
  if (!window.attractions || window.attractions.length === 0) {
    alert('Attractions data not loaded');
    return;
  }

  // ① 当前 MyTrip
  const myTrip = JSON.parse(localStorage.getItem('myTrip') || '[]');

  // ❗ 如果用户已经选了景点 → 不再自动推荐
  if (myTrip.length > 0) {
    alert('You already selected places. Recommendations are only available when MyTrip is empty.');
    return;
  }

  // ② 按 rating 排序（高 → 低）
  const sortedByRating = [...window.attractions]
    .filter(p => typeof p.rating === 'number')
    .sort((a, b) => b.rating - a.rating);

  // ③ 选前 N 个
  const selected = sortedByRating.slice(0, n);

  if (selected.length === 0) {
    alert('No recommended places available');
    return;
  }

  // ④ 加入 MyTrip
  selected.forEach(place => {
    Trip.addToPlanById(place.id);
  });

  // ⑤ 刷新 UI
  displayTripPlaces();

  alert(`Added ${selected.length} recommended places`);
}


    function getTripData() {
      const trips = JSON.parse(localStorage.getItem('myTrip')) || [];
      return trips.map(trip => {
        if (!trip.id) trip.id = generateUniqueId();
        return trip;
      });
    }

    function saveTripData(data) {
      localStorage.setItem('myTrip', JSON.stringify(data));
    }

    function removeFromMyTrip(id) {
      let trips = getTripData();
      const newTrips = trips.filter(trip => trip.id !== id);
      saveTripData(newTrips);
      displayTripPlaces();
      showNotification('Removed from My Trip');
    }

    function displayTripPlaces() {
      removeDuplicateTrips();
      const trips = getTripData();
      if (trips.length === 0) {
        tripList.innerHTML = "<p class='no-items'>You haven't added any places yet.</p>";
        const gp = document.querySelector('.generate-plan');
if (gp) gp.style.display = 'none';

        return;
      }
      tripList.innerHTML = '';
      trips.forEach(trip => {
        const card = document.createElement('div');
        card.className = 'trip-card';
        card.innerHTML = `
          <img src="${trip.image || 'https://via.placeholder.com/250x160?text=No+Image'}" />
          <div class="content">
            <h3>${trip.name}</h3>
            <p><strong>City:</strong> ${trip.city}</p>
          </div>
          <button class="delete-btn">×</button>
        `;
        card.querySelector('.delete-btn').addEventListener('click', () => {
          removeFromMyTrip(trip.id);
        });
        tripList.appendChild(card);
      });
      const gp = document.querySelector('.generate-plan');
if (gp) gp.style.display = 'none';

    }

    async function getWeather(city) {
      try {
        const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&units=metric&appid=${WEATHER_API_KEY}`);
        const data = await response.json();
        if (data.cod === 200) {
          return {
            temp: Math.round(data.main.temp),
            description: data.weather[0].description,
            icon: data.weather[0].icon
          };
        }
        return null;
      } catch {
        return null;
      }
    }



function updateStartLocationOptions(city, type) {
  const select = document.getElementById('startLocation');
  select.innerHTML = '';

  const data = window.startLocations?.[city]?.[type];

  if (!data || data.length === 0) {
    const opt = document.createElement('option');
    opt.textContent = 'No locations available';
    select.appendChild(opt);
    return;
  }

  data.forEach(loc => {
    const opt = document.createElement('option');
    opt.value = loc.id;
    opt.textContent = loc.name;
    opt.dataset.lat = loc.lat;
    opt.dataset.lng = loc.lng;
    select.appendChild(opt);
  });
}

function initStartLocationSelector(city = 'Paris') {
  const type = document.getElementById('startType').value;
  updateStartLocationOptions(city, type);
}
const citySelect = document.getElementById('startCity');
const typeSelect = document.getElementById('startType');

function refreshStartLocation() {
  const city = citySelect.value;
  const type = typeSelect.value;
  updateStartLocationOptions(city, type);
}

citySelect.addEventListener('change', refreshStartLocation);
typeSelect.addEventListener('change', refreshStartLocation);

// 页面加载默认 Paris + Hotel
refreshStartLocation();

    function generateItineraryUI() {
      const trips = getTripData();
      const days = parseInt(daysInput.value);
      if (isNaN(days) || days < 1) return showNotification('Please enter a valid number of days', false);
      if (trips.length === 0) return showNotification('No places in your trip to plan', false);

      const placesPerDay = Math.ceil(trips.length / days);
      itineraryDays.innerHTML = '';
      tripPlacesSection.style.display = 'none';
      itinerarySection.style.display = 'block';

      for (let day = 1; day <= days; day++) {
        const start = (day - 1) * placesPerDay;
        const end = Math.min(start + placesPerDay, trips.length);
        const dayPlaces = trips.slice(start, end);
        const dayPlan = document.createElement('div');
        dayPlan.className = 'day-plan';
        dayPlan.innerHTML = `<h3 class="day-title">Day ${day}</h3>`;
        dayPlaces.forEach((place, idx) => {
          const item = document.createElement('div');
          item.className = 'attraction-item';
          getWeather(place.city).then(weather => {
            const weatherHtml = weather ? `
              <div class="weather-info">
                <img src="http://openweathermap.org/img/wn/${weather.icon}@2x.png" class="weather-icon">
                ${weather.temp}°C, ${weather.description}
              </div>` : '';
            item.innerHTML = `
              <img src="${place.image || 'https://via.placeholder.com/120x80'}" class="attraction-img" />
              <div class="attraction-info">
                <div class="attraction-name">${place.name}</div>
                <div class="attraction-desc">${place.description || 'No description available'}</div>
                ${weatherHtml}
              </div>`;
          });
          dayPlan.appendChild(item);
        });
        itineraryDays.appendChild(dayPlan);
      }
    }

    function generateUniqueId() {
      return 'place-' + Date.now() + '-' + Math.floor(Math.random() * 10000);
    }

    backBtn.addEventListener('click', () => {
      itinerarySection.style.display = 'none';
      tripPlacesSection.style.display = 'block';
    });

// Generate Itinerary 按钮绑定
document.getElementById('generateBtn')
  .addEventListener('click', async () => {
    await Trip.generateItinerary();   // 计算路线 + 距离 + cost
    generateItineraryUI();            // 渲染 Day 1 / Day 2 / 图片 / 天气
  });

  // Add Top 5 Recs 按钮绑定
document.getElementById('addTop5Btn')
  .addEventListener('click', () => {
    addTopNToMyTrip(5);
  });

    displayTripPlaces();
  
</script>
  
</body>
</html>
